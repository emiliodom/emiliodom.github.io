<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test NocoDB Greetings</title>
  <style>
    body{font-family:system-ui,sans-serif;max-width:800px;margin:40px auto;padding:20px;background:#f5f5f5}
    .test-section{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    h2{color:#333;border-bottom:2px solid #667eea;padding-bottom:10px}
    button{background:#667eea;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;margin-right:10px}
    button:hover{background:#5568d3}
    button:disabled{background:#ccc;cursor:not-allowed}
    .result{margin-top:15px;padding:15px;border-radius:6px;background:#f9f9f9;border-left:4px solid #667eea}
    .success{border-left-color:#10b981;background:#f0fdf4}
    .error{border-left-color:#ef4444;background:#fef2f2}
    pre{background:#1e293b;color:#e2e8f0;padding:15px;border-radius:6px;overflow-x:auto;font-size:13px}
    .status{display:inline-block;padding:4px 12px;border-radius:4px;font-size:12px;font-weight:600;margin-left:10px}
    .status.success{background:#10b981;color:#fff}
    .status.error{background:#ef4444;color:#fff}
    .status.pending{background:#f59e0b;color:#fff}
  </style>
</head>
<body>
  <h1>ðŸ§ª NocoDB Greetings Test Suite</h1>
  
  <div class="test-section">
    <h2>1. Configuration Test</h2>
    <button onclick="testConfig()">Test Configuration</button>
    <div id="config-result"></div>
  </div>

  <div class="test-section">
    <h2>2. GET Test (Fetch Greetings)</h2>
    <button onclick="testGet()">Fetch Greetings</button>
    <div id="get-result"></div>
  </div>

  <div class="test-section">
    <h2>3. POST Test (Submit Greeting)</h2>
    <form onsubmit="testPost(event)" style="margin-bottom:15px">
      <input type="text" id="test-message" placeholder="Test message" value="Test greeting from test suite" style="padding:8px;width:300px;border:1px solid #ddd;border-radius:4px;margin-right:10px">
      <input type="text" id="test-feeling" placeholder="Feeling" value="ðŸ˜Š" style="padding:8px;width:60px;border:1px solid #ddd;border-radius:4px;margin-right:10px">
      <button type="submit">Submit Test Greeting</button>
    </form>
    <div id="post-result"></div>
  </div>

  <div class="test-section">
    <h2>4. IP Detection Test</h2>
    <button onclick="testIP()">Detect My IP</button>
    <div id="ip-result"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="/assets/js/nocodb-config.js"></script>
  <script>
    function showResult(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    function testConfig() {
      showResult('config-result', '<span class="status pending">Testing...</span>');
      
      setTimeout(() => {
        if (typeof window.NOCODB_CONFIG === 'undefined') {
          showResult('config-result', '<span class="status error">FAIL</span> NOCODB_CONFIG is not defined', 'error');
          return;
        }

        const config = window.NOCODB_CONFIG;
        const hasPostUrl = !!config.postUrl;
        const hasGetUrl = !!config.getUrl;
        const hasToken = !!config.token;

        if (hasPostUrl && hasGetUrl && hasToken) {
          showResult('config-result', 
            `<span class="status success">PASS</span> Configuration loaded successfully!
            <pre>${JSON.stringify({
              postUrl: config.postUrl.substring(0, 50) + '...',
              getUrl: config.getUrl.substring(0, 50) + '...',
              tokenLength: config.token.length + ' characters'
            }, null, 2)}</pre>`, 'success');
        } else {
          showResult('config-result', 
            `<span class="status error">FAIL</span> Missing configuration: 
            POST URL: ${hasPostUrl ? 'âœ“' : 'âœ—'}, 
            GET URL: ${hasGetUrl ? 'âœ“' : 'âœ—'}, 
            Token: ${hasToken ? 'âœ“' : 'âœ—'}`, 'error');
        }
      }, 100);
    }

    async function testGet() {
      showResult('get-result', '<span class="status pending">Fetching...</span>');
      
      try {
        const config = window.NOCODB_CONFIG;
        const response = await fetch(config.getUrl, {
          headers: {
            'accept': 'application/json',
            'xc-token': config.token
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        let records = [];
        
        if (Array.isArray(data)) {
          records = data;
        } else if (data && Array.isArray(data.list)) {
          records = data.list;
        } else if (data && Array.isArray(data.records)) {
          records = data.records;
        }

        showResult('get-result', 
          `<span class="status success">PASS</span> Fetched ${records.length} greetings successfully!
          <pre>${JSON.stringify(records.slice(0, 3), null, 2)}</pre>
          ${records.length > 3 ? `<p>... and ${records.length - 3} more records</p>` : ''}`, 'success');
      } catch (error) {
        showResult('get-result', 
          `<span class="status error">FAIL</span> Error fetching greetings:
          <pre>${error.message}</pre>`, 'error');
      }
    }

    async function testPost(event) {
      event.preventDefault();
      showResult('post-result', '<span class="status pending">Submitting...</span>');
      
      try {
        const message = document.getElementById('test-message').value;
        const feeling = document.getElementById('test-feeling').value;
        const config = window.NOCODB_CONFIG;

        // Get IP first
        const ipResp = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipResp.json();
        const ip = ipData.ip;

        const payload = {
          Message: message,
          User: ip,
          Notes: feeling
        };

        const response = await fetch(config.postUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'xc-token': config.token
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        showResult('post-result', 
          `<span class="status success">PASS</span> Greeting submitted successfully!
          <pre>${JSON.stringify(result, null, 2)}</pre>
          <p style="margin-top:10px;"><strong>Submitted from IP:</strong> ${ip}</p>`, 'success');
      } catch (error) {
        showResult('post-result', 
          `<span class="status error">FAIL</span> Error submitting greeting:
          <pre>${error.message}\n\nThis could be due to:\n- Invalid API token\n- Network/CORS issues\n- 24-hour rate limit\n- NocoDB server issues</pre>`, 'error');
      }
    }

    async function testIP() {
      showResult('ip-result', '<span class="status pending">Detecting...</span>');
      
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        
        showResult('ip-result', 
          `<span class="status success">PASS</span> IP detected successfully!
          <pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
      } catch (error) {
        showResult('ip-result', 
          `<span class="status error">FAIL</span> Error detecting IP:
          <pre>${error.message}</pre>`, 'error');
      }
    }

    // Auto-run config test on load
    window.addEventListener('load', () => {
      testConfig();
    });
  </script>
</body>
</html>
